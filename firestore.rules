rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Categories Collection
    match /categories/{categoryId} {
      // Anyone can read categories
      allow read: if true;
      
      // Only admins can create, update, or delete categories
      allow create, update, delete: if isAdmin();
    }
    
    // Products Collection
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      
      // Only admins can create, update, or delete products
      allow create, update, delete: if isAdmin();
    }
    
    // Orders Collection
    match /orders/{orderId} {
      // Admins can read all orders
      allow read: if isAdmin();
      
      // Customers can read their own orders (for order tracking)
      allow read: if isAuthenticated() && 
                   exists(/databases/$(database)/documents/orders/$(orderId)) &&
                   get(/databases/$(database)/documents/orders/$(orderId)).data.email == request.auth.token.email;
      
      // Anyone can create an order (for checkout)
      allow create: if true;
      
      // Only admins can update order status and delivery dates
      allow update: if isAdmin();
      
      // No one can delete orders (for record keeping)
      allow delete: if false;
    }
    
    // Admin Users Collection (for storing admin metadata)
    match /admins/{userId} {
      // Only the admin themselves can read their own data
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Only existing admins can create new admins
      allow create, update, delete: if isAdmin();
    }
    
    // Contact Messages Collection
    match /contacts/{contactId} {
      // Anyone can create a contact message (submit form)
      allow create: if true;
      
      // Only admins can read and update contact messages
      allow read, update: if isAdmin();
      
      // Only admins can delete (archive) contact messages
      allow delete: if isAdmin();
    }
    
    // Website Settings Collection
    match /settings/{document=**} {
      // Anyone can read website settings (needed for website to display content)
      allow read: if true;
      
      // Only admins can create, update, or delete settings
      allow create, update, delete: if isAdmin();
    }
    
    // Featured Products Collection (for caching featured products)
    match /featured/{document=**} {
      // Anyone can read featured products
      allow read: if true;
      
      // Only admins can create, update, or delete featured products
      allow create, update, delete: if isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
